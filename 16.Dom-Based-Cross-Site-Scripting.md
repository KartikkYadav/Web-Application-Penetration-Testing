
# DOM-Based Cross-Site-Scripting

## Understanding DOM-Based Cross-Site Scripting (DOM XSS)

### What are Sinks in DOM XSS?
*Sinks* are the specific JavaScript functions, properties, or methods that handle data in a way that causes execution or rendering of attacker-controlled input, leading to potential DOM-based Cross-Site Scripting (XSS) vulnerabilities.  
When untrusted data flows into these sinks without proper sanitization or validation, it may result in malicious script execution in the victim's browser.

---

## Common DOM XSS Sinks

| Sink Type | Sinks / Functions & Properties | Description |
|-----------|--------------------------------|-------------|
| **DOM Manipulation** | `document.write()`, `document.writeln()`, `element.innerHTML`, `element.outerHTML`, `element.insertAdjacentHTML()`, `element.onevent` (e.g., `onclick`) | Write or insert raw HTML or set event handlers dynamically |
| **Location & Navigation** | `location`, `location.href`, `location.host`, `location.hostname`, `location.pathname`, `location.search`, `location.protocol`, `location.assign()`, `location.replace()` | Control page URL, navigation, or inject code via URL manipulation |
| **Window & DOM APIs** | `open()`, `document.domain` | Open new windows or manipulate domain for same-origin policy |
| **AJAX & XMLHttpRequest** | `XMLHttpRequest.open()`, `XMLHttpRequest.send()`, `jQuery.ajax()`, `$.ajax()` | Send or load data dynamically, possibly injecting/loading unsafe scripts |
| **JavaScript Code Execution** | `eval()`, `Function()`, `setTimeout()`, `setInterval()`, `setImmediate()`, `execScript()`, `execCommand()`, `range.createContextualFragment()` | Execute strings as code or manipulate DOM fragments from HTML strings |
| **jQuery Sinks** | `add()`, `after()`, `attr()`, `append()`, `animate()`, `insertAfter()`, `insertBefore()`, `before()`, `html()` | DOM manipulation and attribute setting functions that can inject code |

---

## Explanation
- These sinks act as execution points for potentially malicious data.  
- An attacker uses a controlled source (such as `window.location` or `document.referrer`) to inject data into these sinks.  
- If the sink interprets the data as code or raw HTML without sanitization/encoding, malicious scripts run in the victim's browser.  
- Example: Passing attacker data directly into `element.innerHTML` or `eval()` runs scripts, leading to DOM XSS.

---

## Example from PortSwigger
```javascript
document.write('<script>alert(document.cookie)</script>');
element.innerHTML = '<img src=x onerror=alert(document.cookie)>';
```
Both cause JavaScript execution from attacker-controlled input, making them dangerous sinks.

---

## Summary
### To protect against DOM XSS:
- Identify where untrusted data reaches these sinks.  
- Sanitize or encode data before it hits any sink.  
- Prefer safe alternatives like `textContent` or `setAttribute()` instead of `innerHTML`.  
- Avoid `eval`-like functions when possible.  

---

## What is DOM XSS?
DOM-based XSS is a client-side vulnerability where malicious scripts execute due to insecure manipulation of the Document Object Model (DOM) by JavaScript in the victim’s browser.  
Unlike traditional XSS, DOM XSS does not rely on unsafe server responses but instead unsafe client-side code.

---

## How DOM XSS Works
- When a page loads, the browser creates the DOM (tree-like structure).  
- JavaScript manipulates the DOM dynamically.  
- If JavaScript reads attacker-controlled data (URL parameters, hash, referrer, cookies, etc.) and inserts it into insecure sinks, malicious scripts execute.  

---

## Common Sources of Untrusted Data
- `window.location` (href, search, hash, pathname)  
- `document.referrer`  
- `document.URL`  
- Cookie values  
- `window.name`  

---

## Dangerous Sinks in JavaScript Leading to DOM XSS

### DOM Manipulation Sinks
| Function | Description |
|----------|-------------|
| `document.write()`, `document.writeln()` | Write HTML directly |
| `element.innerHTML`, `element.outerHTML` | Insert HTML content |
| `element.insertAdjacentHTML()` | Insert HTML adjacent |
| `element.onevent` | Assign event handlers |
| `document.domain` | Modify domain |
| `location.*`, `assign()`, `replace()` | Control page navigation |
| `open()` | Open new windows/tabs |
| `XMLHttpRequest.open()`, `.send()` | Handle AJAX |
| `jQuery.ajax()`, `$.ajax()` | jQuery AJAX |

---

### Execution-Related Sinks
| Function | Description |
|----------|-------------|
| `eval()` | Execute string as JS code |
| `Function()` | Create functions from strings |
| `setTimeout()`, `setInterval()`, `setImmediate()` | Execute after delay |
| `execScript()` | Legacy IE |
| `execCommand()` | Editable content |
| `range.createContextualFragment()` | Create DOM from HTML strings |
| `crypto.generateCRMFRequest()` | Crypto request with execution risk |

---

### jQuery Sinks
- `add()`, `after()`, `append()` → Insert HTML  
- `attr()` → Modify attributes  
- `animate()` → Animate CSS  
- `insertAfter()`, `insertBefore()`, `before()` → Insert elements  
- `html()` → Get/Set HTML  

---

## How to Prevent DOM XSS
- Avoid dangerous sinks with untrusted data.  
- Sanitize and encode inputs before DOM insertion.  
- Use safe properties like `textContent` or `setAttribute()`.  
- Avoid `eval()`, `Function()`, etc.  
- Use secure frameworks that escape inputs.  
- Implement Content Security Policy (CSP).  
- Validate and sanitize URL parameters before use.  
- Perform client-side code security testing.  

---

## Final Summary
DOM-based XSS is a critical vulnerability caused by insecure JavaScript handling attacker-controlled data.  
Mitigation requires identifying dangerous sinks, sanitizing inputs, and using safer coding practices.  
